<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotes SPA</title>
</head>
<body>
    <div class="container">
        <h2>Add a Quote</h2>
        <textarea id="quoteText" placeholder="Enter quote text" rows="4"></textarea>
        <input id="quoteAuthor" placeholder="Author (optional)">

        <!-- Tags Dropdown -->
        <label for="tagsSelect">Select Tags:</label>
        <select id="tagsSelect" multiple>
            <!-- Tags will be dynamically populated here -->
        </select>

        <button onclick="addQuote()">Add Quote</button>

        <h2>Quotes</h2>
        <button onclick="fetchMostLikedQuotes()">Show Most Liked Quotes</button>
        <div id="quotesContainer"></div>

        <h2>Add New Tag</h2>
        <div>
            <input type="text" id="newTag" placeholder="Enter new tag" />
            <button onclick="addTag()">Add Tag</button>
        </div>

        <h2>Add Tag to Quotes</h2>
        <label for="tagSelect">Select Tag to Add:</label>
        <select id="tagSelect">
            <!-- Tags will be populated here for selecting the tag to add to quotes -->
        </select>

        <label for="quoteSelect">Select Quotes:</label>
        <select id="quoteSelect" multiple>
            <!-- Quotes will be populated here for selecting which quotes to add the tag -->
        </select>

        <button onclick="addTagToQuotes()">Add Tag to Selected Quotes</button>
    </div>

    <script>
        const apiUrl = "http://localhost:5093/api/quotes";
        const tagsApiUrl = "http://localhost:5093/api/tags"; // Endpoint to fetch tags
        let selectedTags = []; // Store selected tags

        // Fetch tags from the server and populate the dropdown
        async function fetchTags() {
            try {
                const res = await fetch(tagsApiUrl);
                if (!res.ok) throw new Error('Failed to fetch tags');
                const tags = await res.json();
                console.log("Tags fetched:", tags);

                const tagsSelect = document.getElementById("tagsSelect");
                const tagSelect = document.getElementById("tagSelect");
                tagsSelect.innerHTML = '';
                tagSelect.innerHTML = '';
                tags.forEach(tag => {
                    const option = document.createElement("option");
                    option.value = tag.id;
                    option.textContent = tag.name;
                    tagsSelect.appendChild(option);

                    const optionTag = document.createElement("option");
                    optionTag.value = tag.id;
                    optionTag.textContent = tag.name;
                    tagSelect.appendChild(optionTag);
                });
            } catch (error) {
                console.error('Error fetching tags:', error);
            }
        }

        // Fetch quotes from the server
        async function fetchQuotes() {
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error('Failed to fetch quotes');
                const quotes = await res.json();
                displayQuotes(quotes);
                populateQuoteSelect(quotes);
            } catch (error) {
                console.error('Error fetching quotes:', error);
            }
        }

        // Display quotes in the container
        function displayQuotes(quotes) {
            const container = document.getElementById("quotesContainer");
            container.innerHTML = "";
            quotes.forEach(q => {
                const tags = q.tags ? q.tags.map(tag => `<span class="tag">${tag.name}</span>`).join(', ') : "No Tags";
                container.innerHTML += `
                        <div class="quote" id="quote-${q.id}">
                            <p>"${q.text}"</p>
                            <p class="quote-author">- <strong>${q.author || "Unknown"}</strong></p>
                            <p>Tags: ${tags}</p>
                            <p>Likes: ${q.likes} <button onclick="likeQuote(${q.id})">👍 Like</button></p>
                            <button class="edit-btn" onclick="editQuote(${q.id}, '${q.text}', '${q.author}', '${q.tags}')">✏️ Edit</button>
                            <button class="delete-btn" onclick="deleteQuote(${q.id})">🗑️ Delete</button>
                        </div>
                    `;
            });
        }

        // Populate the dropdown for selecting quotes
        function populateQuoteSelect(quotes) {
            const quoteSelect = document.getElementById("quoteSelect");
            quoteSelect.innerHTML = ''; // Clear existing options
            quotes.forEach(q => {
                const option = document.createElement("option");
                option.value = q.id;
                option.textContent = `"${q.text}" - ${q.author || "Unknown"}`;
                quoteSelect.appendChild(option);
            });
        }

        // Add a new quote
        async function addQuote() {
            const text = document.getElementById("quoteText").value;
            const author = document.getElementById("quoteAuthor").value;
            const tagsSelect = document.getElementById("tagsSelect");

            // Get selected tags from the dropdown
            const selectedOptions = Array.from(tagsSelect.selectedOptions);
            selectedTags = selectedOptions.map(option => ({ id: option.value, name: option.textContent }));

            if (!text) return alert("Quote text is required!");

            try {
                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text, author, tags: selectedTags })
                });

                if (!res.ok) throw new Error('Failed to add quote');

                document.getElementById("quoteText").value = "";
                document.getElementById("quoteAuthor").value = "";
                tagsSelect.selectedIndex = -1; // Clear selected tags
                selectedTags = []; // Clear selected tags array
                fetchQuotes(); // Refresh the list of quotes
            } catch (error) {
                console.error('Error adding quote:', error);
            }
        }

        // Like a quote
        async function likeQuote(id) {
            try {
                const res = await fetch(`${apiUrl}/${id}/like`, { method: "POST" });
                if (!res.ok) throw new Error('Failed to like quote');
                fetchQuotes();
            } catch (error) {
                console.error('Error liking quote:', error);
            }
        }

        // Delete a quote
        async function deleteQuote(id) {
            if (confirm("Are you sure you want to delete this quote?")) {
                try {
                    const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
                    if (!res.ok) throw new Error('Failed to delete quote');
                    fetchQuotes();
                } catch (error) {
                    console.error('Error deleting quote:', error);
                }
            }
        }

        // Add a new tag
        async function addTag() {
            const tagName = document.getElementById("newTag").value.trim();
            if (!tagName) return alert("Tag name is required!");

            try {
                const res = await fetch(tagsApiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: tagName })
                });

                if (!res.ok) throw new Error('Failed to add tag');
                document.getElementById("newTag").value = ""; // Clear input field
                fetchTags(); // Refresh the tag list
            } catch (error) {
                console.error('Error adding tag:', error);
            }
        }

        // Add a tag to selected quotes
        async function addTagToQuotes() {
            const tagId = document.getElementById("tagSelect").value;
            const quoteSelect = document.getElementById("quoteSelect");
            const selectedQuoteIds = Array.from(quoteSelect.selectedOptions).map(option => option.value);

            if (!tagId || selectedQuoteIds.length === 0) return alert("Please select a tag and at least one quote!");

            try {
                const res = await fetch(`${apiUrl}/tags`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ tagId, quoteIds: selectedQuoteIds })
                });

                if (!res.ok) throw new Error('Failed to add tag to quotes');
                fetchQuotes(); // Refresh the list of quotes
            } catch (error) {
                console.error('Error adding tag to quotes:', error);
            }
        }

        // Load tags and quotes on page load
        fetchTags();
        fetchQuotes();
    </script>
</body>
</html>
